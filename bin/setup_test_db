#!/usr/bin/env bash
set -euo pipefail

echo "ğŸ”§ Setting up test database..."

# Database configuration
DB_NAME=${DATABASE_NAME:-jasonramirez_test}
DB_USER=${DATABASE_USER:-circleci}
DB_HOST=${DATABASE_HOST:-localhost}

# Create database if it doesn't exist
echo "ğŸ“ Creating database: $DB_NAME"
createdb -h "$DB_HOST" -U "$DB_USER" "$DB_NAME" 2>/dev/null || echo "Database already exists"

# Enable pgvector extension
echo "ğŸ”Œ Enabling pgvector extension..."
psql -h "$DB_HOST" -U "$DB_USER" -d "$DB_NAME" -c "CREATE EXTENSION IF NOT EXISTS vector;" || {
    echo "âš ï¸  Warning: Failed to enable pgvector extension"
    echo "This might be expected in some CI environments"
    echo "Continuing with database setup..."
}

# Load schema from structure.sql
echo "ğŸ“‹ Loading database schema..."
if [ -f "db/structure.sql" ]; then
    psql -h "$DB_HOST" -U "$DB_USER" -d "$DB_NAME" --no-psqlrc --file db/structure.sql > /dev/null || {
        echo "âŒ Failed to load structure.sql"
        exit 1
    }
else
    echo "âŒ db/structure.sql not found"
    exit 1
fi

# Add migration versions using Rails
echo "ğŸ“Š Adding migration versions..."
RAILS_ENV=test bundle exec rails runner "
  migration_versions = Dir[Rails.root.join('db', 'migrate', '*.rb')].map do |file|
    File.basename(file).split('_').first
  end
  
  migration_versions.each do |version|
    begin
      ActiveRecord::SchemaMigration.create!(version: version)
    rescue ActiveRecord::RecordNotUnique
      # Version already exists, skip
    end
  end
  
  puts 'âœ… Migration versions added successfully'
" || {
    echo "âŒ Failed to add migration versions"
    exit 1
}

# Set Rails environment
echo "ğŸŒ Setting Rails test environment..."
RAILS_ENV=test bundle exec rails db:environment:set || {
    echo "âŒ Failed to set Rails environment"
    exit 1
}

echo "âœ… Test database setup complete!"
