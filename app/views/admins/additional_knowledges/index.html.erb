<section class="content content--medium">
  <h1>Knowledge</h1>

  <div class="u-margin-bottom-x-large">
    <h2>Overview</h2>
    <p>
      Both public (posts and case studies) as well as
      private (additional knowledge) that feeds jason.ai.
    </p>
    <div class="u-grid">
      <div class="stat-card">
        <div class="stat-card__number"><%= @posts_count %></div>
        <div class="stat-card__label">Posts</div>
      </div>
      <div class="stat-card">
        <div class="stat-card__number"><%= @case_studies_count %></div>
        <div class="stat-card__label">Case Studies</div>
      </div>
      <div class="stat-card">
        <div class="stat-card__number"><%= @additional_knowledge_count %></div>
        <div class="stat-card__label">Additional</div>
      </div>
      <div class="stat-card">
        <div class="stat-card__number"><%= @total_knowledge_items %></div>
        <div class="stat-card__label">Total</div>
      </div>
    </div>
  </div>

  <div class="u-margin-bottom-x-large">
      <% # Only show generate chunks button if we have knowledge items but no chunks, or if chunks are significantly outdated %>
    <% knowledge_items_count = KnowledgeItem.count %>
    <% chunks_per_item_ratio = knowledge_items_count > 0 ? (@total_chunks.to_f / knowledge_items_count) : 0 %>
    <% should_show_chunk_button = knowledge_items_count > 0 && (chunks_per_item_ratio < 2 || @total_chunks == 0) %>
    

    <h2>Chunks</h2>

    <% if should_show_chunk_button %>
      <div class="banner banner--warning">
        <%= inline_svg "icon-warning.svg" %>
        Chunks are outdated
      </div>
    <% else %>
      <div class="banner banner--notice">
        <%= inline_svg "icon-badge-check.svg" %>
        Chunks are up to date
      </div>
    <% end %>

    <p>
      Focused pieces of content 
      that are automatically created from your 
      larger knowledge items (posts and case studies) that make your 
      content more searchable and relevant.
    </p>
    <div class="u-grid ">
      <div class="stat-card">
        <div class="stat-card__number"><%= @total_chunks %></div>
        <div class="stat-card__label">Chunks</div>
      </div>
    </div>

    <% if should_show_chunk_button %>
      <%= form_with url: generate_chunks_admins_additional_knowledges_path, method: :post, local: true, class: "inline-form" do |form| %>
        <%= form.submit "Generate Chunks", class: "button button--primary", 
            data: { confirm: "This will regenerate chunks for all knowledge items. This may take a few minutes. Continue?" } %>
      <% end %>
    <% end %>
  </div>

  <div class="u-margin-bottom-x-large">
    <% items_without_embeddings = KnowledgeItem.where(content_embedding: nil).count %>
    <% additional_without_embeddings = AdditionalKnowledge.where(content_embedding: nil).count %>
    <% total_without_embeddings = items_without_embeddings + additional_without_embeddings %>

    <h2>Embeddings</h2>

    <% if total_without_embeddings > 0 %>
      <div class="banner banner--warning">
        <%= inline_svg "icon-warning.svg" %>
        Missing Embeddings
      </div>
    <% else %>
      <div class="banner banner--notice">
        <%= inline_svg "icon-badge-check.svg" %>
        All items have embeddings
      </div>
    <% end %>

    <p>
      Vector embeddings enable semantic search in your knowledge base. 
      Generate embeddings for all knowledge items to improve AI search accuracy.
    </p>
    <div class="u-grid u-margin-bottom-medium">
      <div class="stat-card">
        <div class="stat-card__number"><%= KnowledgeItem.where(category: 'Blog Post').with_embeddings.count %></div>
        <div class="stat-card__label">Posts with Embeddings</div>
      </div>
      <div class="stat-card">
        <div class="stat-card__number"><%= KnowledgeItem.where(category: 'Case Study').with_embeddings.count %></div>
        <div class="stat-card__label">Case Studies with Embeddings</div>
      </div>
      <div class="stat-card">
        <div class="stat-card__number"><%= AdditionalKnowledge.with_embeddings.count %></div>
        <div class="stat-card__label">Additional with Embeddings</div>
      </div>
    </div>

    <% if total_without_embeddings > 0 %>
      <% if items_without_embeddings > 0 %>
        <table class="table--tight u-margin-bottom-large">
          <thead>
            <tr>
              <th>Knowledge Item</th>
              <th>Category</th>
            </tr>
          </thead>
          <tbody>
            <% KnowledgeItem.where(content_embedding: nil).each do |item| %>
              <tr>
                <td><%= item.title %></td>
                <td><%= item.category %></td>
              </tr>
            <% end %>
          </tbody>
        </table>
      <% end %>
      
      <% if additional_without_embeddings > 0 %>
        <table class="table--tight u-margin-bottom-large">
          <thead>
            <tr>
              <th>Additional Knowledge</th>
              <th>Created</th>
            </tr>
          </thead>
          <tbody>
            <% AdditionalKnowledge.where(content_embedding: nil).each do |item| %>
              <tr>
                <td><%= item.title %></td>
                <td><%= item.created_at.strftime("%b %d, %Y") %></td>
              </tr>
            <% end %>
          </tbody>
        </table>
      <% end %>
      
      <%= form_with url: generate_embeddings_admins_additional_knowledges_path, method: :post, local: true, class: "inline-form" do |form| %>
        <%= form.submit "Generate Embeddings", class: "button button--primary", 
            data: { confirm: "This will generate embeddings for all items without them. This may take a few minutes. Continue?" } %>
      <% end %>

    <% end %>
  </div>

  <div class="u-margin-bottom-x-large">
    <h2>Posts</h2>

    <% if @pending_posts_count > 0 %>
      <div class="banner banner--warning">
        <%= inline_svg "icon-warning.svg" %>
        Pending Posts
      </div>
    <% else %>
      <div class="banner banner--notice">
        <%= inline_svg "icon-badge-check.svg" %>
        All posts are in the knowledge base
      </div>
    <% end %>

    <p>
      Posts aren't automatically added to the knowledge base, 
      so until you add them by hitting the button below, 
      they will not be searchable in the knowledge base.
    </p>

    <div class="u-grid u-margin-bottom-medium">
      <div class="stat-card">
        <div class="stat-card__number"><%= @posts_count %></div>
        <div class="stat-card__label">Posts Added</div>
      </div>
    </div>

    <% if @pending_posts_count > 0 %> 
      <table class="table--tight u-margin-bottom-large">
        <thead>
          <tr>
            <th>Title</th>
          </tr>
        </thead>
        <tbody>
        <% @pending_posts.each do |post| %>
          <tr>
            <td><%= post.title %></td>
          </tr>
        <% end %>
      </table>

      <%= form_with url: update_knowledge_base_admins_additional_knowledges_path, method: :post, local: true, class: "inline-form" do |form| %>
        <%= form.submit "Update Knowledge Base", class: "button button--primary", 
            data: { confirm: "This will import all published posts and case studies. Continue?" } %>
      <% end %>
    <% end %>
  </div>

  <div class="u-margin-bottom-x-large">
    <h2>Case Studies</h2>

    <% if @pending_case_studies_count > 0 %>
      <div class="banner banner--warning">
        <%= inline_svg "icon-warning.svg" %>
        Pending Case Studies
      </div>
    <% else %>
      <div class="banner banner--notice">
        <%= inline_svg "icon-badge-check.svg" %>
        All case studies are in the knowledge base
      </div>
    <% end %>

    <p>
      Case studies aren't automatically added to the knowledge base.
      If you don't see a case study below, it hasn't been added to the knowledge base.
      You'll need to add them manually by hitting the button below.
    </p>

    <% if @knowledge_base_case_studies.any? %>
      <div class="u-grid u-margin-bottom-medium">
        <div class="stat-card">
          <div class="stat-card__number"><%= @knowledge_base_case_studies.count %></div>
          <div class="stat-card__label">Case Studies Added</div>
        </div>
      </div>
    <% end %>

    <% if @pending_case_studies_count > 0 %>
        <p>The following case studies need to be added to the knowledge base:</p>
        
        <table class="table--tight u-margin-bottom-large">
          <thead>
            <tr>
              <th>Title</th>
            </tr>
          </thead>
          <tbody>
            <% @pending_case_studies.each do |case_study_title| %>
              <tr>
                <td><%= case_study_title %></td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
      <%= form_with url: update_knowledge_base_admins_additional_knowledges_path, method: :post, local: true, class: "inline-form" do |form| %>
        <%= form.submit "Update Knowledge Base", class: "button button--primary", 
            data: { confirm: "This will import all published posts and case studies. Continue?" } %>
      <% end %>
    <% end %>
  </div>

  <!-- Additional Knowledge Section -->
  <div class="u-margin-bottom-x-large">
    <h2>Additional Knowledge</h2>

    <% if @additional_knowledges.any? %>
      <div class="banner banner--notice">
        <%= inline_svg "icon-badge-check.svg" %>
        Additional knowledge is added to the knowledge base
      </div>
    <% end %>

    <p>Private knowledge that informs JasonAI but isn't public content.</p>

    <% if @additional_knowledges.any? %>
      <table class="table--tight table--last-col-small">
        <thead>
          <tr>
            <th>Title</th>
            <th>Created</th>
            <th>Delete</th>
          </tr>
        </thead>
        <tbody>
          <% @additional_knowledges.each do |knowledge| %>
            <tr>
              <td>
                <%= link_to knowledge.title, edit_admins_additional_knowledge_path(knowledge) %>
              </td>
              <td>
                <%= knowledge.created_at.strftime("%b %d, %Y") %>
              </td>
              <td>
                <%= link_to admins_additional_knowledge_path(knowledge), 
                    method: :delete, 
                    data: { confirm: "Are you sure?" } do %>
                  <%= inline_svg "icon-trashcan.svg", height: "16", width: "16" %>
                <% end %>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    <% end %>

    <%= link_to "Add Knowledge",
      new_admins_additional_knowledge_path,
      class: "button button--primary" %>
  </div>
</section>